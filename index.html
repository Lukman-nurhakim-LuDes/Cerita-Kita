<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Hub v2.5 | Lukman & Destry</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        html.dark ::-webkit-scrollbar-track { background: #2d3748; }
        html.dark ::-webkit-scrollbar-thumb { background: #718096; }
        .content-section, #auth-screen, #hub-screen, #app-container { display: none; }
        .content-section.active, #auth-screen.active, #hub-screen.active, #app-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { position: relative; aspect-ratio: 1/1; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #ef4444; }
        html.dark .calendar-day.has-event::after { background-color: #f87171; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 40; display: none; justify-content: center; align-items: center; }
        .modal-content { z-index: 50; max-height: 90vh; overflow-y: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .habit-table-container { width: 100%; overflow-x: auto; }
        .habit-table { border-collapse: collapse; width: 100%; min-width: 800px; }
        .habit-table th, .habit-table td { border: 1px solid #e2e8f0; text-align: center; padding: 0; }
        html.dark .habit-table th, html.dark .habit-table td { border-color: #4a5568; }
        .habit-table th { padding: 8px; font-size: 0.875rem; }
        .habit-table .habit-name { text-align: left; padding: 12px; min-width: 150px; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .habit-day-cell { width: 40px; height: 40px; cursor: pointer; transition: background-color 0.2s; }
        .habit-day-cell:hover { background-color: #f7fafc; }
        html.dark .habit-day-cell:hover { background-color: #2d3748; }
        .status-none { background-color: transparent; }
        .status-lukman { background-color: #bee3f8; }
        .status-destry { background-color: #fed7e2; }
        .status-both { background: linear-gradient(135deg, #bee3f8 50%, #fed7e2 50%); }
        html.dark .status-lukman { background-color: #2b6cb0; }
        html.dark .status-destry { background-color: #97266d; }
        html.dark .status-both { background: linear-gradient(135deg, #2b6cb0 50%, #97266d 50%); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex flex-col justify-center items-center z-[100]">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-medium">Memuat Life Hub...</p>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
            <!-- Login View -->
            <div id="login-view">
                <h1 class="text-3xl font-bold text-center mb-2">Selamat Datang!</h1>
                <p class="text-center text-gray-500 mb-6">Masuk untuk melanjutkan</p>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required>
                    <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600">Masuk</button>
                </form>
                <p class="text-center text-sm text-gray-500 mt-6">
                    Belum punya akun? <a href="#" id="show-register-link" class="font-semibold text-blue-500 hover:underline">Daftar di sini</a>
                </p>
            </div>

            <!-- Register View (hidden by default) -->
            <div id="register-view" style="display: none;">
                <h1 class="text-3xl font-bold text-center mb-2">Buat Akun Baru</h1>
                <p class="text-center text-gray-500 mb-6">Isi data untuk mendaftar</p>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" placeholder="Email" class="w-full p-3 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required>
                    <input type="password" id="register-password" placeholder="Password (min. 6 karakter)" class="w-full p-3 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required>
                    <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600">Daftar Akun Baru</button>
                </form>
                <p class="text-center text-sm text-gray-500 mt-6">
                    Sudah punya akun? <a href="#" id="show-login-link" class="font-semibold text-blue-500 hover:underline">Masuk di sini</a>
                </p>
            </div>
            <!-- Shared Error Display -->
            <p id="auth-error" class="text-red-500 text-center mt-4 font-mono text-sm h-4"></p>
        </div>
    </div>
    
    <!-- Hub Management Screen -->
    <div id="hub-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center">
            <h1 class="text-3xl font-bold mb-4">Hub Keluarga</h1>
            <p class="text-gray-500 mb-6">Buat hub baru untuk keluarga Anda atau gabung ke hub pasangan Anda menggunakan ID.</p>
            <button id="create-hub-btn" class="w-full bg-pink-500 text-white p-3 rounded-lg font-semibold hover:bg-pink-600 mb-4">Buat Hub Baru</button>
            <p class="my-4 font-semibold">ATAU</p>
            <form id="join-hub-form" class="flex gap-2">
                <input type="text" id="join-hub-id" placeholder="Masukkan ID Hub" class="flex-grow p-3 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600">
                <button type="submit" class="bg-blue-500 text-white px-6 rounded-lg font-semibold hover:bg-blue-600">Gabung</button>
            </form>
            <p id="hub-error" class="text-red-500 mt-4"></p>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="flex h-screen">
        <aside class="w-20 lg:w-64 bg-white dark:bg-gray-800 shadow-lg flex flex-col transition-all duration-300">
            <div class="flex items-center justify-center lg:justify-start lg:pl-6 h-16 border-b dark:border-gray-700">
                <i class="fa-solid fa-heart-pulse text-2xl text-pink-500"></i>
                <span class="hidden lg:inline ml-3 text-xl font-bold">Life Hub</span>
            </div>
            <nav class="flex-grow mt-4">
                <ul id="nav-list" class="space-y-2 px-2 lg:px-4"></ul>
            </nav>
            <div class="p-4 border-t dark:border-gray-700 space-y-2">
                <button id="theme-toggle" class="w-full flex items-center justify-center lg:justify-start p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fa-solid fa-moon"></i>
                    <span class="hidden lg:inline ml-4">Mode Gelap</span>
                </button>
                <button id="logout-btn" class="w-full flex items-center justify-center lg:justify-start p-2 rounded-lg text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span class="hidden lg:inline ml-4">Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
            
            <section id="dashboard" class="content-section space-y-6">
                 <h1 class="text-3xl font-bold">Dashboard: Ringkasan Hidup</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold text-gray-500 dark:text-gray-400">Saldo Keuangan</h3><p id="dashboard-saldo" class="text-3xl font-bold text-green-500 mt-2">Rp 0</p></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold text-gray-500 dark:text-gray-400">Total Tabungan</h3><p id="dashboard-tabungan" class="text-3xl font-bold text-blue-500 mt-2">Rp 0</p></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold text-gray-500 dark:text-gray-400">Mood Hari Ini</h3><p id="dashboard-mood" class="text-4xl mt-2">ðŸ˜¶</p></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold text-gray-500 dark:text-gray-400">Habit Selesai (Hari Ini)</h3><p id="dashboard-habit-completion" class="text-3xl font-bold mt-2">0%</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold mb-4">Grafik Pemasukan vs Pengeluaran (Bulan Ini)</h3><canvas id="incomeExpenseChart"></canvas></div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold mb-4">Grafik Pengeluaran per Kategori</h3><canvas id="expenseChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold mb-4">Mood Tracker (7 Hari Terakhir)</h3>
                        <div id="dashboard-mood-tracker" class="flex justify-around items-end h-32"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="font-semibold mb-4">Progress Habit Harian</h3><div id="dashboard-habits" class="space-y-4"></div></div>
                </div>
            </section>
            <section id="keuangan" class="content-section">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Keuangan Harian</h1><button onclick="openModal('modal-transaksi')" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Transaksi</button></div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6 flex flex-wrap gap-4 items-center">
                    <div><label for="filter-bulan" class="text-sm font-medium">Filter Bulan:</label><input type="month" id="filter-bulan" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2"></div>
                    <div class="flex-grow"><label for="filter-pasangan" class="text-sm font-medium">Filter Pasangan:</label><select id="filter-pasangan" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2"><option value="semua">Semua</option><option value="Lukman">Lukman</option><option value="Destry">Destry</option></select></div>
                    <div class="text-right flex-grow"><h3 class="font-semibold text-lg">Saldo Berjalan (Bulan Terpilih):</h3><p id="saldo-berjalan" class="text-2xl font-bold text-green-500">Rp 0</p></div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left"><thead class="border-b dark:border-gray-700"><tr><th class="p-4">Tanggal</th><th class="p-4">Kategori</th><th class="p-4">Jumlah</th><th class="p-4">Oleh</th><th class="p-4">Catatan</th><th class="p-4">Aksi</th></tr></thead><tbody id="tabel-transaksi-body"></tbody></table></div>
            </section>
            <section id="tabungan" class="content-section">
                 <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Target Tabungan</h1><button onclick="openModal('modal-tabungan')" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Target</button></div>
                <div id="savings-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
            <section id="diary" class="content-section">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Diary Harian</h1><button onclick="openModal('modal-diary')" class="bg-purple-500 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-600 transition"><i class="fa-solid fa-plus mr-2"></i>Tulis Diary Baru</button></div>
                <div id="diary-entries" class="space-y-6"></div>
            </section>
            <section id="habit" class="content-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold">Habit Tracker Bulanan</h1>
                    <button onclick="openModal('modal-habit')" class="bg-indigo-500 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-600 transition w-full sm:w-auto"><i class="fa-solid fa-plus mr-2"></i>Tambah Habit</button>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <button id="habit-prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button>
                        <h2 id="habit-month-year" class="text-xl font-bold"></h2>
                        <button id="habit-next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div id="habit-table-container" class="habit-table-container">
                    </div>
                </div>
            </section>
            <section id="wishlist" class="content-section">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Wishlist Bersama</h1><button onclick="openModal('modal-wishlist')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Wishlist</button></div>
                <div id="wishlist-gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </section>
            <section id="kalender" class="content-section">
                <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold">Kalender Aktivitas</h1><button onclick="openModal('modal-aktivitas')" class="bg-teal-500 text-white px-4 py-2 rounded-lg shadow hover:bg-teal-600 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Aktivitas</button></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button><h2 id="calendar-month-year" class="text-xl font-bold"></h2><button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button></div>
                        <div class="grid grid-cols-7 text-center font-semibold text-gray-500 dark:text-gray-400 mb-2"><div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div></div>
                        <div id="calendar-grid" class="calendar-grid"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Aktivitas Terpilih</h3><p id="selected-date-display" class="font-semibold mb-2"></p><div id="daily-activities" class="space-y-4"><p class="text-gray-500">Pilih tanggal di kalender untuk melihat aktivitas.</p></div></div>
                </div>
            </section>
            <section id="profil" class="content-section">
                <h1 class="text-3xl font-bold mb-6">Profil & Pengaturan</h1>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Informasi Akun</h2>
                    <p class="mb-2"><strong>Email:</strong> <span id="profile-email"></span></p>
                    <p class="mb-4"><strong>User ID:</strong> <span id="profile-uid" class="text-xs text-gray-500 break-all"></span></p>
                    <h2 class="text-2xl font-bold mb-4 mt-6">Informasi Hub</h2>
                    <p class="mb-2">Bagikan ID Hub ini kepada pasangan Anda untuk bergabung.</p>
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                        <code id="profile-hub-id" class="font-mono text-lg break-all"></code>
                        <button onclick="copyHubId()" class="text-gray-500 hover:text-blue-500 ml-4"><i class="fa-solid fa-copy"></i></button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- All Modals remain unchanged -->
    <div id="modal-habit" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Tambah Habit Baru</h2><form id="form-habit"><div class="space-y-4"><div><label for="habit-nama" class="block mb-1 font-medium">Nama Habit</label><input type="text" id="habit-nama" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-habit')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Simpan</button></div></form></div></div>
    <div id="modal-transaksi" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Tambah Transaksi Baru</h2><form id="form-transaksi"><div class="space-y-4"><input type="hidden" id="transaksi-id"><div><label for="transaksi-tanggal" class="block mb-1 font-medium">Tanggal</label><input type="date" id="transaksi-tanggal" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="transaksi-kategori" class="block mb-1 font-medium">Kategori</label><select id="transaksi-kategori" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required><option>Pemasukan</option><option>Makan & Minum</option><option>Belanja</option><option>Transportasi</option><option>Tagihan</option><option>Hiburan</option><option>Kesehatan</option><option>Lainnya</option></select></div><div><label for="transaksi-jumlah" class="block mb-1 font-medium">Jumlah (Rp)</label><input type="number" id="transaksi-jumlah" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="transaksi-oleh" class="block mb-1 font-medium">Oleh</label><select id="transaksi-oleh" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required><option>Lukman</option><option>Destry</option></select></div><div><label for="transaksi-catatan" class="block mb-1 font-medium">Catatan</label><textarea id="transaksi-catatan" rows="2" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600"></textarea></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-transaksi')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Simpan</button></div></form></div></div>
    <div id="modal-tabungan" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Target Tabungan Baru</h2><form id="form-tabungan"><div class="space-y-4"><input type="hidden" id="tabungan-id"><div><label for="tabungan-nama" class="block mb-1 font-medium">Nama Target</label><input type="text" id="tabungan-nama" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="tabungan-target" class="block mb-1 font-medium">Target Jumlah (Rp)</label><input type="number" id="tabungan-target" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="tabungan-awal" class="block mb-1 font-medium">Nominal Awal (Rp)</label><input type="number" id="tabungan-awal" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" value="0" required></div><div><label for="tabungan-oleh" class="block mb-1 font-medium">Dibuat Oleh</label><select id="tabungan-oleh" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required><option>Bersama</option><option>Lukman</option><option>Destry</option></select></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-tabungan')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Simpan</button></div></form></div></div>
    <div id="modal-tambah-dana" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Tambah Dana ke Tabungan</h2><form id="form-tambah-dana"><input type="hidden" id="tambah-dana-id"><div class="space-y-4"><div><label for="tambah-dana-jumlah" class="block mb-1 font-medium">Jumlah (Rp)</label><input type="number" id="tambah-dana-jumlah" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="tambah-dana-catatan" class="block mb-1 font-medium">Catatan</label><input type="text" id="tambah-dana-catatan" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" placeholder="misal: Gaji bulan ini"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-tambah-dana')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Tambah</button></div></form></div></div>
    <div id="modal-diary" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Tulis Diary</h2><form id="form-diary"><div class="space-y-4"><input type="hidden" id="diary-id"><div><label for="diary-tanggal" class="block mb-1 font-medium">Tanggal</label><input type="date" id="diary-tanggal" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="diary-judul" class="block mb-1 font-medium">Judul</label><input type="text" id="diary-judul" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="diary-isi" class="block mb-1 font-medium">Isi Diary</label><textarea id="diary-isi" rows="5" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></textarea></div><div class="flex items-center justify-between"><div><label for="diary-mood" class="block mb-1 font-medium">Mood</label><select id="diary-mood" class="p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600 text-2xl" required><option value="ðŸ˜Š">ðŸ˜Š Bahagia</option><option value="ðŸ˜‚">ðŸ˜‚ Sangat Bahagia</option><option value="ðŸ™‚">ðŸ™‚ Biasa Saja</option><option value="ðŸ˜¢">ðŸ˜¢ Sedih</option><option value="ðŸ˜ ">ðŸ˜  Marah</option><option value="ðŸ˜´">ðŸ˜´ Lelah</option></select></div><div><label for="diary-oleh" class="block mb-1 font-medium">Penulis</label><select id="diary-oleh" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required><option>Lukman</option><option>Destry</option></select></div></div><div><label for="diary-foto" class="block mb-1 font-medium">Upload Foto (Opsional)</label><input type="file" id="diary-foto" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/50 dark:file:text-blue-300 dark:hover:file:bg-blue-900"><img id="diary-foto-preview" class="hidden mt-4 max-h-48 rounded-lg"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-diary')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Simpan</button></div></form></div></div>
    <div id="modal-wishlist" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Tambah Wishlist</h2><form id="form-wishlist"><div class="space-y-4"><input type="hidden" id="wishlist-id"><div><label for="wishlist-nama" class="block mb-1 font-medium">Nama Barang</label><input type="text" id="wishlist-nama" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="wishlist-kategori" class="block mb-1 font-medium">Kategori</label><input type="text" id="wishlist-kategori" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" placeholder="e.g., Elektronik, Furnitur"></div><div><label for="wishlist-oleh" class="block mb-1 font-medium">Keinginan</label><select id="wishlist-oleh" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required><option>Lukman</option><option>Destry</option><option>Bersama</option></select></div><div><label for="wishlist-deskripsi" class="block mb-1 font-medium">Deskripsi</label><textarea id="wishlist-deskripsi" rows="3" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600"></textarea></div><div><label for="wishlist-foto" class="block mb-1 font-medium">Upload Foto (Opsional)</label><input type="file" id="wishlist-foto" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 dark:file:bg-yellow-900/50 dark:file:text-yellow-300 dark:hover:file:bg-yellow-900"><img id="wishlist-foto-preview" class="hidden mt-4 max-h-48 rounded-lg"></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-wishlist')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Simpan</button></div></form></div></div>
    <div id="modal-aktivitas" class="modal-backdrop"><div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">Tambah Aktivitas</h2><form id="form-aktivitas"><input type="hidden" id="aktivitas-id"><div class="space-y-4"><div><label for="aktivitas-nama" class="block mb-1 font-medium">Nama Aktivitas</label><input type="text" id="aktivitas-nama" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="aktivitas-tanggal" class="block mb-1 font-medium">Tanggal</label><input type="date" id="aktivitas-tanggal" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="aktivitas-waktu" class="block mb-1 font-medium">Waktu</label><input type="time" id="aktivitas-waktu" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600" required></div><div><label for="aktivitas-deskripsi" class="block mb-1 font-medium">Deskripsi</label><textarea id="aktivitas-deskripsi" rows="3" class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:border-gray-600"></textarea></div><div><label class="block mb-1 font-medium">Siapa yang ikut?</label><div class="flex gap-4"><label class="flex items-center"><input type="checkbox" id="aktivitas-ikut-lukman" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span class="ml-2">Lukman</span></label><label class="flex items-center"><input type="checkbox" id="aktivitas-ikut-destry" class="h-4 w-4 rounded border-gray-300 text-pink-600 focus:ring-pink-500"><span class="ml-2">Destry</span></label></div></div></div><div class="mt-6 flex justify-end gap-4"><button type="button" onclick="closeModal('modal-aktivitas')" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Batal</button><button type="submit" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600">Simpan</button></div></form></div></div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, Timestamp, writeBatch, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, Timestamp, writeBatch, getDocs, serverTimestamp, orderBy
        };
    </script>
    <script>
        function mainApp() {
            const {
                initializeApp,
                getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
                getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, Timestamp, writeBatch, getDocs, serverTimestamp, orderBy
            } = window.firebase;

            const firebaseConfig = {
                apiKey: "AIzaSyA5GRzA83x8DbaxUb5pRH_Yx0ZWMsCVN0w",
                authDomain: "jalan-cerita-5c989.firebaseapp.com",
                projectId: "jalan-cerita-5c989",
                storageBucket: "jalan-cerita-5c989.appspot.com",
                messagingSenderId: "606590919634",
                appId: "1:606590919634:web:039ddf6e2b7e13d0675e0b",
                measurementId: "G-9L0MLVQCNL"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let currentUser = null;
            let currentHubId = null;
            let unsubscribeListeners = [];
            let expenseChartInstance, incomeExpenseChartInstance;
            let calendarDate = new Date();
            let habitDate = new Date();

            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const hubScreen = document.getElementById('hub-screen');
            const appContainer = document.getElementById('app-container');

            const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            const getTodayISO = () => new Date().toISOString().split('T')[0];
            const formatDate = (isoDate) => {
                if (!isoDate) return '';
                const date = (isoDate.seconds) ? new Date(isoDate.seconds * 1000) : new Date(isoDate);
                return date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };
            const showUI = (element) => {
                loadingScreen.style.display = 'none';
                authScreen.style.display = 'none';
                hubScreen.style.display = 'none';
                appContainer.style.display = 'none';
                if (element) {
                    element.style.display = 'flex';
                }
            };

            function setupAuthEventListeners() {
                document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-view').style.display = 'none'; document.getElementById('register-view').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
                document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; document.getElementById('auth-error').textContent = ''; });
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('register-form').addEventListener('submit', handleRegister);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists() && userDocSnap.data().hubId) {
                        currentHubId = userDocSnap.data().hubId;
                        initializeAppUI();
                    } else {
                        showUI(hubScreen);
                    }
                } else {
                    currentUser = null;
                    currentHubId = null;
                    unsubscribeAll();
                    showUI(authScreen);
                }
            });
            
            function initializeAppUI() {
                setupNavigation();
                setupAppEventListeners();
                setupTheme();
                navigateTo('dashboard');
                attachRealtimeListeners();
                showUI(appContainer);
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-uid').textContent = currentUser.uid;
                document.getElementById('profile-hub-id').textContent = currentHubId;
            }

            function attachRealtimeListeners() {
                if (!currentHubId) return;
                unsubscribeAll();
                const collectionsToRender = {
                    'transactions': renderKeuangan, 'savings': renderTabungan, 'diary': renderDiary,
                    'habits': renderHabitTable, 'habitEntries': renderHabitTable,
                    'wishlist': renderWishlist, 'events': renderCalendar
                };
                Object.keys(collectionsToRender).forEach(col => {
                    const q = query(collection(db, "hubs", currentHubId, col));
                    const unsubscribe = onSnapshot(q, () => {
                        if (collectionsToRender[col]) collectionsToRender[col]();
                        renderDashboard();
                    }, (error) => { console.error(`Error listening to ${col}:`, error); });
                    unsubscribeListeners.push(unsubscribe);
                });
            }
            function unsubscribeAll() { unsubscribeListeners.forEach(unsub => unsub()); unsubscribeListeners = []; }

            function setupNavigation() {
                const navItems = [
                    { id: 'dashboard', icon: 'fa-solid fa-table-columns', text: 'Dashboard' },
                    { id: 'keuangan', icon: 'fa-solid fa-wallet', text: 'Keuangan' },
                    { id: 'tabungan', icon: 'fa-solid fa-piggy-bank', text: 'Tabungan' },
                    { id: 'diary', icon: 'fa-solid fa-book-open', text: 'Diary' },
                    { id: 'habit', icon: 'fa-solid fa-check-double', text: 'Habit Tracker' },
                    { id: 'wishlist', icon: 'fa-solid fa-star', text: 'Wishlist' },
                    { id: 'kalender', icon: 'fa-solid fa-calendar-days', text: 'Kalender' },
                    { id: 'profil', icon: 'fa-solid fa-user-gear', text: 'Profil' },
                ];
                const navList = document.getElementById('nav-list');
                navList.innerHTML = navItems.map(item => `<li><a href="#" class="nav-link flex items-center p-2 lg:p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-target="${item.id}"><i class="${item.icon} w-6 text-center text-lg"></i><span class="hidden lg:inline ml-4 font-medium">${item.text}</span></a></li>`).join('');
                document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.target); }));
            }
            window.navigateTo = (pageId) => {
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-300');
                    if (link.dataset.target === pageId) {
                        link.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-300');
                    }
                });
                window.scrollTo(0, 0);
            }
            window.openModal = (modalId) => { document.getElementById(modalId).style.display = 'flex'; };
            window.closeModal = (modalId) => { document.getElementById(modalId).style.display = 'none'; };

            function setupTheme() {
                const themeToggle = document.getElementById('theme-toggle');
                const toggleIcon = themeToggle.querySelector('i');
                const toggleText = themeToggle.querySelector('span');
                const applyTheme = (isDark) => {
                    document.documentElement.classList.toggle('dark', isDark);
                    toggleIcon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                    toggleText.textContent = isDark ? 'Mode Terang' : 'Mode Gelap';
                    if(expenseChartInstance || incomeExpenseChartInstance) renderDashboard();
                };
                const currentTheme = localStorage.getItem('theme');
                applyTheme(currentTheme === 'dark');
                themeToggle.addEventListener('click', () => {
                    const isDark = !document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    applyTheme(isDark);
                });
            }
            
            function setupAppEventListeners() {
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('create-hub-btn').addEventListener('click', createHub);
                document.getElementById('join-hub-form').addEventListener('submit', joinHub);
                document.getElementById('form-transaksi').addEventListener('submit', handleTransaksiSubmit);
                document.getElementById('form-tabungan').addEventListener('submit', handleTabunganSubmit);
                document.getElementById('form-tambah-dana').addEventListener('submit', handleTambahDanaSubmit);
                document.getElementById('form-diary').addEventListener('submit', handleDiarySubmit);
                document.getElementById('form-habit').addEventListener('submit', handleHabitSubmit);
                document.getElementById('form-wishlist').addEventListener('submit', handleWishlistSubmit);
                document.getElementById('form-aktivitas').addEventListener('submit', handleAktivitasSubmit);
                document.getElementById('filter-bulan').value = new Date().toISOString().slice(0, 7);
                document.getElementById('filter-bulan').addEventListener('change', renderKeuangan);
                document.getElementById('filter-pasangan').addEventListener('change', renderKeuangan);
                document.getElementById('habit-prev-month').addEventListener('click', () => changeHabitMonth(-1));
                document.getElementById('habit-next-month').addEventListener('click', () => changeHabitMonth(1));
                document.getElementById('prev-month').addEventListener('click', () => changeCalendarMonth(-1));
                document.getElementById('next-month').addEventListener('click', () => changeCalendarMonth(1));
                setupImagePreview('diary-foto', 'diary-foto-preview');
                setupImagePreview('wishlist-foto', 'wishlist-foto-preview');
                document.querySelectorAll('.modal-backdrop').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); }));
            }

            async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const errorEl = document.getElementById('auth-error'); errorEl.textContent = ''; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Login Error:", error.code, error.message); errorEl.textContent = `Error: ${error.code}`; } }
            async function handleRegister(e) { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; const errorEl = document.getElementById('auth-error'); errorEl.textContent = ''; if (password.length < 6) { errorEl.textContent = "Password minimal 6 karakter."; return; } try { await createUserWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Register Error:", error.code, error.message); errorEl.textContent = `Error: ${error.code}`; } }
            async function handleLogout() { if(confirm('Anda yakin ingin logout?')) await signOut(auth); }
            async function createHub() { const hubId = doc(collection(db, 'hubs')).id; try { const batch = writeBatch(db); batch.set(doc(db, "hubs", hubId), { members: [currentUser.uid], createdAt: serverTimestamp() }); batch.set(doc(db, "users", currentUser.uid), { hubId: hubId }, { merge: true }); await batch.commit(); currentHubId = hubId; initializeAppUI(); } catch (error) { console.error("Create Hub Error:", error); document.getElementById('hub-error').textContent = "Gagal membuat hub."; } }
            async function joinHub(e) { e.preventDefault(); const hubId = document.getElementById('join-hub-id').value.trim(); if (!hubId) return; const hubRef = doc(db, "hubs", hubId); const hubSnap = await getDoc(hubRef); if (hubSnap.exists()) { try { const members = hubSnap.data().members || []; if (members.includes(currentUser.uid)) {} else { await updateDoc(hubRef, { members: [...members, currentUser.uid] }); } await setDoc(doc(db, "users", currentUser.uid), { hubId: hubId }, { merge: true }); currentHubId = hubId; initializeAppUI(); } catch (error) { console.error("Join Hub Error:", error); document.getElementById('hub-error').textContent = "Gagal bergabung dengan hub."; } } else { document.getElementById('hub-error').textContent = "ID Hub tidak ditemukan."; } }
            
            window.copyHubId = () => { const hubId = document.getElementById('profile-hub-id').textContent; navigator.clipboard.writeText(hubId).then(() => alert('ID Hub disalin!')); };
            function changeHabitMonth(delta) { habitDate.setMonth(habitDate.getMonth() + delta); renderHabitTable(); }
            function changeCalendarMonth(delta) { calendarDate.setMonth(calendarDate.getMonth() + delta); renderCalendar(); }
            
            // --- FULLY IMPLEMENTED FUNCTIONS ---
            async function renderKeuangan() {
                if (!currentHubId) return;
                const monthFilter = document.getElementById('filter-bulan').value;
                const personFilter = document.getElementById('filter-pasangan').value;
                const [year, month] = monthFilter.split('-').map(Number);
                const startDate = Timestamp.fromDate(new Date(year, month - 1, 1));
                const endDate = Timestamp.fromDate(new Date(year, month, 1));
                let q = query(collection(db, "hubs", currentHubId, "transactions"), where("tanggal", ">=", startDate), where("tanggal", "<", endDate), orderBy("tanggal", "desc"));
                const querySnapshot = await getDocs(q);
                let transactions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (personFilter !== 'semua') {
                    transactions = transactions.filter(t => t.oleh === personFilter);
                }
                const body = document.getElementById('tabel-transaksi-body');
                body.innerHTML = transactions.map(t => {
                    const isPemasukan = t.kategori === 'Pemasukan';
                    const amountColor = isPemasukan ? 'text-green-500' : 'text-red-500';
                    const amountPrefix = isPemasukan ? '+' : '-';
                    return `<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="p-4">${formatDate(t.tanggal)}</td>
                        <td class="p-4">${t.kategori}</td>
                        <td class="p-4 font-semibold ${amountColor}">${amountPrefix} ${formatCurrency(t.jumlah)}</td>
                        <td class="p-4">${t.oleh}</td>
                        <td class="p-4">${t.catatan || '-'}</td>
                        <td class="p-4"><button onclick="deleteTransaction('${t.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
                }).join('');
                if (transactions.length === 0) {
                    body.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Belum ada transaksi di bulan ini.</td></tr>`;
                }
                const saldo = transactions.reduce((acc, t) => t.kategori === 'Pemasukan' ? acc + t.jumlah : acc - t.jumlah, 0);
                document.getElementById('saldo-berjalan').textContent = formatCurrency(saldo);
            }
            window.deleteTransaction = async (id) => { if (confirm('Yakin hapus transaksi ini?')) { await deleteDoc(doc(db, "hubs", currentHubId, "transactions", id)); } };
            
            async function handleTransaksiSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const dateValue = document.getElementById('transaksi-tanggal').value;
                const date = new Date(dateValue);
                date.setUTCHours(12);
                const newTransaksi = {
                    tanggal: Timestamp.fromDate(date),
                    kategori: document.getElementById('transaksi-kategori').value,
                    jumlah: parseFloat(document.getElementById('transaksi-jumlah').value),
                    oleh: document.getElementById('transaksi-oleh').value,
                    catatan: document.getElementById('transaksi-catatan').value,
                    createdAt: serverTimestamp(), createdBy: currentUser.uid
                };
                try { await addDoc(collection(db, "hubs", currentHubId, "transactions"), newTransaksi); closeModal('modal-transaksi'); form.reset(); } 
                catch (error) { console.error("Error adding transaction: ", error); alert("Gagal menyimpan transaksi."); }
            }

            async function renderTabungan() {
                if (!currentHubId) return;
                const q = query(collection(db, "hubs", currentHubId, "savings"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                const savings = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const list = document.getElementById('savings-list');
                if (savings.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 md:col-span-2 lg:col-span-3 text-center py-8">Belum ada target tabungan.</p>`;
                    return;
                }
                list.innerHTML = savings.map(s => {
                    const progress = Math.min((s.terkumpul / s.target) * 100, 100);
                    const progressColor = progress >= 100 ? 'bg-green-500' : 'bg-blue-500';
                    return `<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex flex-col fade-in">
                        <div class="flex justify-between items-start">
                            <div><h3 class="text-xl font-bold">${s.nama}</h3><p class="text-sm text-gray-500 dark:text-gray-400">Oleh: ${s.oleh}</p></div>
                            <button onclick="deleteTabungan('${s.id}')" class="text-gray-400 hover:text-red-500 text-sm"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="my-4 flex-grow">
                            <div class="flex justify-between text-sm font-medium mb-1"><span>${formatCurrency(s.terkumpul)}</span><span class="text-gray-500">${formatCurrency(s.target)}</span></div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4"><div class="${progressColor} h-4 rounded-full" style="width: ${progress}%"></div></div>
                            <p class="text-right text-sm font-bold mt-1">${progress.toFixed(1)}%</p>
                        </div>
                        <button onclick="openTambahDanaModal('${s.id}')" class="mt-4 w-full bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">Tambah Dana</button>
                    </div>`;
                }).join('');
            }
            window.deleteTabungan = async (id) => { if (confirm('Yakin hapus target tabungan ini?')) { await deleteDoc(doc(db, "hubs", currentHubId, "savings", id)); } };
            window.openTambahDanaModal = (id) => { document.getElementById('tambah-dana-id').value = id; openModal('modal-tambah-dana'); };
            async function handleTabunganSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const newTabungan = {
                    nama: document.getElementById('tabungan-nama').value,
                    target: parseFloat(document.getElementById('tabungan-target').value),
                    terkumpul: parseFloat(document.getElementById('tabungan-awal').value),
                    oleh: document.getElementById('tabungan-oleh').value,
                    createdAt: serverTimestamp()
                };
                try { await addDoc(collection(db, "hubs", currentHubId, "savings"), newTabungan); closeModal('modal-tabungan'); form.reset(); }
                catch (error) { console.error("Error adding savings goal:", error); alert("Gagal menyimpan target."); }
            }
            async function handleTambahDanaSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const id = document.getElementById('tambah-dana-id').value;
                const jumlah = parseFloat(document.getElementById('tambah-dana-jumlah').value);
                const tabunganRef = doc(db, "hubs", currentHubId, "savings", id);
                const tabunganSnap = await getDoc(tabunganRef);
                if (tabunganSnap.exists()) {
                    const newTerkumpul = (tabunganSnap.data().terkumpul || 0) + jumlah;
                    await updateDoc(tabunganRef, { terkumpul: newTerkumpul });
                }
                closeModal('modal-tambah-dana');
                form.reset();
            }

            async function renderDiary() {
                if (!currentHubId) return;
                const q = query(collection(db, "hubs", currentHubId, "diary"), orderBy("tanggal", "desc"));
                const snapshot = await getDocs(q);
                const diary = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const container = document.getElementById('diary-entries');
                if (diary.length === 0) { container.innerHTML = `<p class="text-gray-500 text-center py-8">Belum ada tulisan diary.</p>`; return; }
                container.innerHTML = diary.map(entry => `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md fade-in">
                        <div class="flex justify-between items-start">
                            <div><h3 class="text-2xl font-bold">${entry.judul} <span class="text-3xl">${entry.mood}</span></h3><p class="text-sm text-gray-500 dark:text-gray-400">${formatDate(entry.tanggal)} - oleh ${entry.oleh}</p></div>
                            <button onclick="deleteDiary('${entry.id}')" class="text-gray-400 hover:text-red-500 text-sm"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        ${entry.foto ? `<img src="${entry.foto}" alt="Foto diary" class="my-4 rounded-lg max-h-80 w-auto mx-auto">` : ''}
                        <p class="mt-4 whitespace-pre-wrap">${entry.isi}</p>
                    </div>`).join('');
            }
            window.deleteDiary = async (id) => { if (confirm('Yakin hapus entri diary ini?')) { await deleteDoc(doc(db, "hubs", currentHubId, "diary", id)); } };
            async function handleDiarySubmit(e) {
                e.preventDefault();
                const form = e.target;
                const fotoPreview = document.getElementById('diary-foto-preview');
                const date = new Date(document.getElementById('diary-tanggal').value);
                date.setUTCHours(12);
                const newEntry = {
                    tanggal: Timestamp.fromDate(date),
                    judul: document.getElementById('diary-judul').value,
                    isi: document.getElementById('diary-isi').value,
                    mood: document.getElementById('diary-mood').value,
                    oleh: document.getElementById('diary-oleh').value,
                    foto: fotoPreview.src.startsWith('data:image') ? fotoPreview.src : null,
                    createdAt: serverTimestamp()
                };
                try { await addDoc(collection(db, "hubs", currentHubId, "diary"), newEntry); closeModal('modal-diary'); form.reset(); fotoPreview.classList.add('hidden'); fotoPreview.src = ''; }
                catch (error) { console.error("Error adding diary:", error); alert("Gagal menyimpan diary."); }
            }

            async function renderWishlist() {
                if (!currentHubId) return;
                const q = query(collection(db, "hubs", currentHubId, "wishlist"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                const wishlist = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const gallery = document.getElementById('wishlist-gallery');
                if (wishlist.length === 0) { gallery.innerHTML = `<p class="text-gray-500 text-center py-8 sm:col-span-2 md:col-span-3 lg:col-span-4">Belum ada wishlist.</p>`; return; }
                gallery.innerHTML = wishlist.map(wish => `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden fade-in">
                        <img src="${wish.foto || 'https://placehold.co/400x300/e2e8f0/64748b?text=Gambar'}" alt="${wish.nama}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="font-bold text-lg">${wish.nama}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${wish.kategori}</p>
                            <p class="text-sm mt-2">Keinginan: <span class="font-semibold">${wish.oleh}</span></p>
                            <p class="text-sm mt-2 text-gray-600 dark:text-gray-300">${wish.deskripsi}</p>
                            <button onclick="deleteWishlist('${wish.id}')" class="mt-4 text-xs text-red-500 hover:underline">Hapus</button>
                        </div>
                    </div>`).join('');
            }
            window.deleteWishlist = async (id) => { if (confirm('Yakin hapus wishlist ini?')) { await deleteDoc(doc(db, "hubs", currentHubId, "wishlist", id)); } };
            async function handleWishlistSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const fotoPreview = document.getElementById('wishlist-foto-preview');
                const newWish = {
                    nama: document.getElementById('wishlist-nama').value,
                    kategori: document.getElementById('wishlist-kategori').value,
                    oleh: document.getElementById('wishlist-oleh').value,
                    deskripsi: document.getElementById('wishlist-deskripsi').value,
                    foto: fotoPreview.src.startsWith('data:image') ? fotoPreview.src : null,
                    createdAt: serverTimestamp()
                };
                try { await addDoc(collection(db, "hubs", currentHubId, "wishlist"), newWish); closeModal('modal-wishlist'); form.reset(); fotoPreview.classList.add('hidden'); fotoPreview.src = ''; }
                catch (error) { console.error("Error adding wishlist:", error); alert("Gagal menyimpan wishlist."); }
            }

            async function renderCalendar() {
                if (!currentHubId) return;
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                document.getElementById('calendar-month-year').textContent = new Date(year, month).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const startDate = Timestamp.fromDate(new Date(year, month, 1));
                const endDate = Timestamp.fromDate(new Date(year, month + 1, 1));
                const q = query(collection(db, "hubs", currentHubId, "events"), where("tanggal", ">=", startDate), where("tanggal", "<", endDate));
                const snapshot = await getDocs(q);
                const eventsThisMonth = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

                for (let i = 0; i < firstDay; i++) { grid.innerHTML += '<div></div>'; }
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateISO = date.toISOString().split('T')[0];
                    const hasEvent = eventsThisMonth.some(e => new Date(e.tanggal.seconds * 1000).toISOString().split('T')[0] === dateISO);
                    const isToday = dateISO === getTodayISO();
                    const dayEl = document.createElement('div');
                    dayEl.className = `calendar-day flex items-center justify-center cursor-pointer rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50 transition`;
                    if (isToday) dayEl.classList.add('bg-blue-500', 'text-white', 'font-bold');
                    if (hasEvent) dayEl.classList.add('has-event');
                    dayEl.textContent = day;
                    dayEl.dataset.date = dateISO;
                    dayEl.addEventListener('click', () => renderDailyActivities(dateISO, eventsThisMonth));
                    grid.appendChild(dayEl);
                }
            }
            function renderDailyActivities(dateISO, eventsThisMonth) {
                document.querySelectorAll('.calendar-day.bg-gray-300').forEach(d => d.classList.remove('bg-gray-300', 'dark:bg-gray-600'));
                const dayEl = document.querySelector(`.calendar-day[data-date="${dateISO}"]`);
                if(dayEl) dayEl.classList.add('bg-gray-300', 'dark:bg-gray-600');
                document.getElementById('selected-date-display').textContent = formatDate(dateISO);
                const activitiesContainer = document.getElementById('daily-activities');
                const dailyEvents = eventsThisMonth.filter(e => new Date(e.tanggal.seconds * 1000).toISOString().split('T')[0] === dateISO).sort((a,b) => a.waktu.localeCompare(b.waktu));
                if (dailyEvents.length === 0) { activitiesContainer.innerHTML = `<p class="text-gray-500">Tidak ada aktivitas terjadwal.</p>`; return; }
                activitiesContainer.innerHTML = dailyEvents.map(event => `
                    <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${event.nama} <span class="text-sm font-normal text-gray-500">(${event.waktu})</span></p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">${event.deskripsi || ''}</p>
                                <div class="text-xs mt-1">
                                    ${event.ikut.lukman ? '<span class="bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">Lukman</span>' : ''}
                                    ${event.ikut.destry ? '<span class="bg-pink-200 text-pink-800 px-2 py-0.5 rounded-full">Destry</span>' : ''}
                                </div>
                            </div>
                            <button onclick="deleteAktivitas('${event.id}')" class="text-gray-400 hover:text-red-500 text-sm"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            }
            window.deleteAktivitas = async (id) => { if (confirm('Yakin hapus aktivitas ini?')) { await deleteDoc(doc(db, "hubs", currentHubId, "events", id)); } };
            async function handleAktivitasSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const date = new Date(document.getElementById('aktivitas-tanggal').value);
                date.setUTCHours(12);
                const newEvent = {
                    nama: document.getElementById('aktivitas-nama').value,
                    tanggal: Timestamp.fromDate(date),
                    waktu: document.getElementById('aktivitas-waktu').value,
                    deskripsi: document.getElementById('aktivitas-deskripsi').value,
                    ikut: { lukman: document.getElementById('aktivitas-ikut-lukman').checked, destry: document.getElementById('aktivitas-ikut-destry').checked },
                    createdAt: serverTimestamp()
                };
                try { await addDoc(collection(db, "hubs", currentHubId, "events"), newEvent); closeModal('modal-aktivitas'); form.reset(); }
                catch (error) { console.error("Error adding event:", error); alert("Gagal menyimpan aktivitas."); }
            }

            async function handleHabitSubmit(e) { e.preventDefault(); const name = document.getElementById('habit-nama').value.trim(); if (!name) return; try { await addDoc(collection(db, "hubs", currentHubId, "habits"), { name: name, createdAt: serverTimestamp() }); closeModal('modal-habit'); e.target.reset(); } catch (error) { console.error("Error adding habit: ", error); } }
            async function renderHabitTable() {
                if (!currentHubId) return;
                document.getElementById('habit-month-year').textContent = habitDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                const container = document.getElementById('habit-table-container');
                container.innerHTML = '<div class="loader mx-auto"></div>';
                const habitsQuery = query(collection(db, "hubs", currentHubId, "habits"), orderBy("name"));
                const habitsSnapshot = await getDocs(habitsQuery);
                const habits = habitsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const year = habitDate.getFullYear();
                const month = habitDate.getMonth();
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0, 23, 59, 59);
                const entriesQuery = query(collection(db, "hubs", currentHubId, "habitEntries"), where("date", ">=", startDate), where("date", "<=", endDate));
                const entriesSnapshot = await getDocs(entriesQuery);
                const entriesMap = new Map();
                entriesSnapshot.docs.forEach(doc => { const data = doc.data(); const dateKey = new Date(data.date.seconds * 1000).toISOString().split('T')[0]; entriesMap.set(dateKey, { id: doc.id, ...data }); });
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let tableHTML = '<table class="habit-table"><thead><tr><th class="habit-name">Habit</th>';
                for (let i = 1; i <= daysInMonth; i++) { tableHTML += `<th>${i}</th>`; }
                tableHTML += '</tr></thead><tbody>';
                if (habits.length === 0) { tableHTML += `<tr><td colspan="${daysInMonth + 1}" class="text-center p-8 text-gray-500">Belum ada habit. Tambahkan satu!</td></tr>`; } 
                else {
                    habits.forEach(habit => {
                        tableHTML += `<tr><td class="habit-name" title="${habit.name}">${habit.name}</td>`;
                        for (let day = 1; day <= daysInMonth; day++) {
                            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const entry = entriesMap.get(dateKey);
                            const status = entry?.statuses?.[habit.id] || { lukman: false, destry: false };
                            let statusClass = 'status-none';
                            if (status.lukman && status.destry) statusClass = 'status-both';
                            else if (status.lukman) statusClass = 'status-lukman';
                            else if (status.destry) statusClass = 'status-destry';
                            tableHTML += `<td><div class="habit-day-cell ${statusClass}" onclick="cycleHabitStatus('${habit.id}', '${dateKey}')"></div></td>`;
                        }
                        tableHTML += '</tr>';
                    });
                }
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            }
            window.cycleHabitStatus = async (habitId, dateKey) => {
                const date = new Date(dateKey);
                date.setUTCHours(12);
                const entryDocId = dateKey;
                const entryRef = doc(db, "hubs", currentHubId, "habitEntries", entryDocId);
                const entrySnap = await getDoc(entryRef);
                const currentStatuses = entrySnap.exists() ? entrySnap.data().statuses : {};
                const currentStatus = currentStatuses[habitId] || { lukman: false, destry: false };
                let nextStatus = { lukman: false, destry: false };
                if (!currentStatus.lukman && !currentStatus.destry) { nextStatus = { lukman: true, destry: false }; } 
                else if (currentStatus.lukman && !currentStatus.destry) { nextStatus = { lukman: false, destry: true }; } 
                else if (!currentStatus.lukman && currentStatus.destry) { nextStatus = { lukman: true, destry: true }; }
                const newStatuses = { ...currentStatuses, [habitId]: nextStatus };
                try { await setDoc(entryRef, { date: Timestamp.fromDate(date), statuses: newStatuses }, { merge: true }); } catch (error) { console.error("Error updating habit status: ", error); }
            };
            function setupImagePreview(inputId, previewId) { const input = document.getElementById(inputId); const preview = document.getElementById(previewId); input.addEventListener('change', () => { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { preview.src = e.target.result; preview.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { preview.src = ''; preview.classList.add('hidden'); } }); }
            
            // Initial setup
            setupAuthEventListeners();
        }

        document.addEventListener('DOMContentLoaded', mainApp);
    </script>
</body>
</html>
